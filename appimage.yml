version: 1

AppDir:
  path: ./AppDir

  app_info:
    id: com.siproxylin
    name: Siproxylin
    icon: siproxylin
    version: dev
    exec: usr/bin/python3
    exec_args: "$APPDIR/usr/share/siproxylin/main.py --xdg $@"

  apt:
    arch: amd64
    sources:
      - sourceline: 'deb [arch=amd64] http://deb.debian.org/debian bookworm main'
        key_url: 'https://ftp-master.debian.org/keys/archive-key-12.asc'

    include:
      - python3
      - python3-pip
      - libgstreamer1.0-0
      - libgstreamer-plugins-base1.0-0
      - gstreamer1.0-plugins-good
      - gstreamer1.0-plugins-bad
      - gstreamer1.0-pulseaudio
      - libpulse0
      - libgl1
      - libxcb-xinerama0
      - libxkbcommon-x11-0
      - libxcb-icccm4
      - libxcb-image0
      - libxcb-keysyms1
      - libxcb-randr0
      - libxcb-render-util0
      - libxcb-shape0
      - libdbus-1-3
      - libenchant-2-2
      - hunspell-en-us
      - hunspell-de-de
      - hunspell-ru
      - hunspell-lt
      - hunspell-es
      - hunspell-ro
      - hunspell-ar

    exclude:
      - adwaita-icon-theme
      - humanity-icon-theme

  files:
    include:
      - /usr/local/bin/drunk-call-service-linux
    exclude:
      - usr/share/man
      - usr/share/doc/*/README.*
      - usr/share/doc/*/changelog.*
      - usr/share/doc/*/NEWS.*
      - usr/share/doc/*/TODO.*

  runtime:
    path_mappings:
      - /usr/lib/x86_64-linux-gnu/gconv:$APPDIR/usr/lib/x86_64-linux-gnu/gconv

    env:
      APPDIR_LIBRARY_PATH: "$APPDIR/usr/lib/x86_64-linux-gnu:$APPDIR/usr/lib:$APPDIR/lib/x86_64-linux-gnu"
      PYTHONHOME: "$APPDIR/usr"
      PYTHONPATH: "$APPDIR/usr/lib/python3.11:$APPDIR/usr/lib/python3.11/site-packages"
      GST_PLUGIN_PATH: "$APPDIR/usr/lib/x86_64-linux-gnu/gstreamer-1.0"
      GST_PLUGIN_SYSTEM_PATH: "$APPDIR/usr/lib/x86_64-linux-gnu/gstreamer-1.0"
      PULSE_SYSTEM: "0"

  after_bundle:
    # Install Python dependencies
    - mkdir -p AppDir/usr/lib/python3.11/site-packages
    - pip3 install --ignore-installed --target=AppDir/usr/lib/python3.11/site-packages -r requirements.txt
    # Copy application files
    - mkdir -p AppDir/usr/share/siproxylin
    - cp -r siproxylin AppDir/usr/share/siproxylin/
    - cp -r drunk_xmpp AppDir/usr/share/siproxylin/
    - cp -r drunk_call_hook AppDir/usr/share/siproxylin/
    - cp main.py AppDir/usr/share/siproxylin/
    # Copy Go call service binary
    - mkdir -p AppDir/usr/local/bin
    - cp drunk_call_service/bin/drunk-call-service-linux AppDir/usr/local/bin/
    - chmod +x AppDir/usr/local/bin/drunk-call-service-linux
    # Copy icon and desktop file
    - mkdir -p AppDir/usr/share/icons/hicolor/scalable/apps
    - cp siproxylin/resources/icons/siproxylin.svg AppDir/usr/share/icons/hicolor/scalable/apps/
    - mkdir -p AppDir/usr/share/applications
    - cp siproxylin.desktop AppDir/usr/share/applications/

AppImage:
  arch: x86_64
  update-information: None
  sign-key: None
