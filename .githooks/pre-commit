#!/bin/bash
# Pre-commit hook: Validate version.sh changes
# Ensures version increases and codename changes

# Only run if version.sh changed
git diff --cached --name-only | grep -q "^version\.sh$" || exit 0

# Source staged version.sh
eval "$(git show :version.sh | grep '^SIPROXYLIN_')"

# Normalize and validate format
CURR="${SIPROXYLIN_VERSION#v}"
if ! [[ "$CURR" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo "ERROR: Invalid version format: $SIPROXYLIN_VERSION (expected X.Y.Z)" >&2
    exit 1
fi
CURR="v$CURR"

# Get previous from latest tag
PREV=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
PREV_CODE=$(git tag -l --format='%(contents)' "$PREV" 2>/dev/null | head -1)

# Version must increase
if ! [ "$(printf '%s\n' "${CURR#v}" "${PREV#v}" | sort -V | tail -1)" = "${CURR#v}" ]; then
    echo "ERROR: Version must increase: $PREV → $CURR" >&2
    exit 1
fi
if [ "$CURR" = "$PREV" ]; then
    echo "ERROR: Version unchanged: $CURR" >&2
    exit 1
fi

# Codename must change
if [ "$SIPROXYLIN_CODENAME" = "$PREV_CODE" ]; then
    echo "WARN: Codename remains unchanged (was '$PREV_CODE')" >&2
fi

echo "✓ Version bump: $PREV → $CURR ($SIPROXYLIN_CODENAME)"

# Auto-generate CHANGELOG.md
echo "Generating CHANGELOG.md..."
HOOK_DIR=$(dirname "$(readlink -f "$0")")
if [ -x "$HOOK_DIR/generate-changelog.sh" ]; then
    if "$HOOK_DIR/generate-changelog.sh"; then
        # Stage the updated CHANGELOG.md
        git add CHANGELOG.md 2>/dev/null || true
        echo "✓ CHANGELOG.md updated and staged"
    else
        echo "ERROR: Failed to generate CHANGELOG.md" >&2
        exit 1
    fi
else
    echo "WARN: generate-changelog.sh not found or not executable" >&2
fi

exit 0
